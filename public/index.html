<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>4x4 Meyv…ô Slot</title>
<style>
  body {
    margin: 0; padding: 0;
    background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
    background-size: cover;
    font-family: Arial, sans-serif;
    color: #fff;
    text-align: center;
  }
  #slot {
    margin: 30px auto;
    width: 400px;
    height: 400px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: 10px;
    background: rgba(0,0,0,0.5);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 20px #ff9800;
  }
  .cell {
    background: #222;
    border-radius: 8px;
    font-size: 48px;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    box-shadow: inset 0 0 10px #ffb74d;
    transition: transform 0.2s ease;
  }
  .highlight {
    background: #ffb74d;
    color: #000;
    box-shadow: 0 0 15px 5px #ffd54f;
    transform: scale(1.1);
  }
  #controls {
    margin-top: 20px;
  }
  #balance {
    font-size: 24px;
    margin-bottom: 15px;
    font-weight: bold;
  }
  #bet {
    width: 80px;
    font-size: 18px;
    padding: 6px;
    border-radius: 6px;
    border: none;
    text-align: center;
  }
  #spinBtn {
    background: #ff9800;
    border: none;
    padding: 10px 25px;
    font-size: 20px;
    color: #000;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    margin-left: 15px;
    transition: background 0.3s ease;
  }
  #spinBtn:disabled {
    background: #ffa726aa;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<h1>4x4 Meyv…ô Slot</h1>
<div id="balance">Balans: 0 ‚Çº</div>

<div id="slot"></div>

<div id="controls">
  M…ôrc: <input type="number" id="bet" min="1" value="10" />
  <button id="spinBtn">Fƒ±rlat</button>
</div>

<script>
  const slot = document.getElementById('slot');
  const balanceElem = document.getElementById('balance');
  const betInput = document.getElementById('bet');
  const spinBtn = document.getElementById('spinBtn');

  // Meyv…ô emojil…ôri
  const fruits = ['üçí','üçã','üçä','üçâ','üçá','üçì','ü•ù','üçç'];

  // 4x4 slot √º√ß√ºn 16 h√ºceyr…ô yaradƒ±lƒ±r
  const size = 4;
  const cells = [];

  let balance = 0;
  let userId = localStorage.getItem('userId');

  if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userId', userId);
  }

  // Slot h√ºceyr…ôl…ôrini yarat
  for(let i=0; i < size*size; i++) {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    cell.textContent = '‚ùì';
    slot.appendChild(cell);
    cells.push(cell);
  }

  // Balansƒ± serverd…ôn g…ôtir
  function fetchBalance() {
    fetch(`http://localhost:3000/balance/${userId}`)
      .then(res => res.json())
      .then(data => {
        balance = data.balance;
        updateBalanceDisplay();
      });
  }

  function updateBalanceDisplay() {
    balanceElem.textContent = `Balans: ${balance} ‚Çº`;
  }

  // Qalib s…ôtir v…ô s√ºtunlarƒ± tapƒ±b vurƒüulamaq √º√ß√ºn
  function findWinningLines(grid) {
    const highlights = [];

    // Yatay s…ôtirl…ôr (4)
    for(let r=0; r < size; r++) {
      let rowSet = new Set();
      for(let c=0; c < size; c++) {
        rowSet.add(grid[r*size + c]);
      }
      if(rowSet.size === 1) {
        for(let c=0; c < size; c++) highlights.push(r*size + c);
      }
    }

    // ≈ûaquli s√ºtunlar (4)
    for(let c=0; c < size; c++) {
      let colSet = new Set();
      for(let r=0; r < size; r++) {
        colSet.add(grid[r*size + c]);
      }
      if(colSet.size === 1) {
        for(let r=0; r < size; r++) highlights.push(r*size + c);
      }
    }
    return highlights;
  }

  // Fƒ±rlat d√ºym…ôsi klik
  spinBtn.addEventListener('click', () => {
    let bet = Number(betInput.value);
    if (isNaN(bet) || bet < 1) {
      alert('Z…ôhm…ôt olmasa d√ºzg√ºn m…ôrc daxil edin!');
      return;
    }
    if (bet > balance) {
      alert('Balansƒ±nƒ±z kifay…ôt etmir!');
      return;
    }

    spinBtn.disabled = true;

    let spins = 0;
    const maxSpins = 20;
    let finalGrid = [];

    const interval = setInterval(() => {
      let grid = [];
      for(let i=0; i < size*size; i++) {
        const fruit = fruits[Math.floor(Math.random() * fruits.length)];
        cells[i].textContent = fruit;
        grid.push(fruit);
      }
      spins++;
      if(spins === maxSpins) {
        clearInterval(interval);
        finalGrid = grid;

        // Qalib x…ôtl…ôr tapƒ±lƒ±r
        const wins = findWinningLines(finalGrid);
        cells.forEach(cell => cell.classList.remove('highlight'));
        wins.forEach(i => cells[i].classList.add('highlight'));

        // Qalibdirs…ô 5x multiplikator
        const isWin = wins.length > 0;
        const winMultiplier = isWin ? 5 : 0;

        // Server…ô m…ôrc v…ô qalibiyy…ôt g√∂nd…ôr
        fetch(`http://localhost:3000/play/${userId}`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ bet, winMultiplier })
        })
        .then(res => res.json())
        .then(data => {
          balance = data.balance;
          updateBalanceDisplay();
          alert(isWin ? 'Qalib oldunuz!' : 'Qalib olmadƒ±nƒ±z, yenid…ôn c…ôhd edin!');
          spinBtn.disabled = false;
        })
        .catch(() => {
          alert('Server …ôlaq…ôsi x…ôtasƒ±.');
          spinBtn.disabled = false;
        });
      }
    }, 80);
  });

  fetchBalance();
</script>

</body>
</html>
